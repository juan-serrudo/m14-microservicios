networks:
  public_net:
  private_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24

volumes:
  storage_sqlite_data:
  kafka_data:
  keycloak_data:

services:
  # Kafka Broker en modo KRaft (sin ZooKeeper)
  kafka:
    image: bitnamilegacy/kafka:3.7.0
    hostname: kafka
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://172.30.0.10:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@127.0.0.1:9093
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_KRAFT_CLUSTER_ID=4L6g3nShT-eMCtK--X86sw
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      private_net:
        aliases:
          - kafka
        ipv4_address: 172.30.0.10
    ports:
      - "9092:9092"
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list >/dev/null 2>&1",
        ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 40s

  # Inicialización de tópicos Kafka
  kafka-init:
    image: bitnamilegacy/kafka:3.7.0
    depends_on:
      kafka:
        condition: service_healthy
    network_mode: "service:kafka"
    command:
      - /bin/bash
      - -lc
      - |
        for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
          /opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --if-not-exists --topic passwords.v1.events --partitions 1 --replication-factor 1 && exit 0
          echo "Esperando Kafka..."
          sleep 5
        done
        exit 1
    restart: "no"

  # Keycloak - Servidor de autenticación OAuth2/OpenID Connect
  keycloak:
    image: quay.io/keycloak/keycloak:25.0.0
    hostname: keycloak
    command:
      - start-dev
      - --import-realm
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HTTP_ENABLED=true
      - KC_HTTP_PORT=8080
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    networks:
      - private_net
    ports:
      - "8081:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /realms/master HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n' >&3 && cat <&3 | grep -q 'HTTP/1.1' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Load Balancer delante de A (2 réplicas)
  lb-a:
    build: ./lb-a
    image: m14/lb-a:latest
    depends_on:
      - password-service-1
      - password-service-2
    ports:
      - "8080:80"
    networks:
      - public_net
      - private_net
    restart: unless-stopped

  password-service-1:
    build: ../microservices/password-service
    image: m14/password-service:latest
    env_file:
      - ./env/password-service.example.env
    environment:
      - SERVICE_INSTANCE_ID=ps-1
    networks:
      - private_net
    depends_on:
      storage-sqlite:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  password-service-2:
    build: ../microservices/password-service
    image: m14/password-service:latest
    env_file:
      - ./env/password-service.example.env
    environment:
      - SERVICE_INSTANCE_ID=ps-2
    networks:
      - private_net
    depends_on:
      storage-sqlite:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  storage-sqlite:
    build: ../microservices/storage-sqlite
    image: m14/storage-sqlite:latest
    env_file:
      - ./env/storage-sqlite.example.env
    volumes:
      - storage_sqlite_data:/data
    ports:
      - "3001:3001"
    networks:
      - private_net
    depends_on:
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build: ./frontend
    image: m14/frontend:latest
    ports:
      - "3000:80"
    networks:
      - public_net
    restart: unless-stopped

